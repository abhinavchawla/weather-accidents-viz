<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualization lab2</title>
    <style>
        html {
            background-color: #fbfbfb;
        }
        h1 {
            color: #0099FF;
        }

        /* Legend Position Style */
.legend {
	position:absolute;
	left:20px;
	top:18%;
}
        p {
            color: #000000;
        }

        tr {
            background-color: #FF8448;

        }

        td {
            background-color: #0099FF;

        }

        table {
            color: #FFFFFF;
        }

        svg {
            font: 10px sans-serif;
        }

        .background path {
            fill: none;
            stroke: #ddd;
            shape-rendering: crispEdges;
        }

        .foreground path {
            fill: none;
            stroke: steelblue;
        }
        .state {
                stroke: #000;
            }
                .county {
                stroke: #000;
            }
        .brush .extent {
            fill-opacity: .3;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        .axis line,
        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .axis text {
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
            cursor: move;
        }

        .axis .axis-label {
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Legend Font Style */
        #chloropleth {
            /* font: 11px sans-serif;
            background-color: #ffffff; */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #pcp {
            display: flex;
            flex-direction: column;
        }
        .axis text {
            font: 10px sans-serif;
        }

        .axis line, .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        /******************************************
* Metric Modal Chart (Views, Downloads, Citations)
********************************************/

        /* When there is no data ...*/

        #metric-modal .metric-chart text {
            fill: #565656;
            font-size: 9px;
            font-family: Helvetica, Arial, "sans serif";
        }

        #metric-modal .metric-chart text.no-data {
            font-size: 16px;
            font-weight: 100;
            fill: #d0d0d0;
        }

        #metric-modal .metric-chart rect.no-data {
            fill: #f5f5f5;
        }

        /* When there is data ...*/

        /* CB: padding to display better on bl.ocks.org */
        #metric-modal {
            /* padding: 64px; */
            display: flex;
            flex-direction: column;
        }

        #metric-modal .metric-chart rect.plot-background {
            fill: white;
        }

        #metric-modal .metric-chart path.line {
            fill: none;
            stroke: #6695C4; /* default, changed in each theme */
            stroke-width: 1.5px;
            clip-path: url(#clip);
        }

        #metric-modal .metric-chart path.area {
            fill: #6695C4; /* CB default, changed in each theme */
            opacity: 0.6;
            clip-path: url(#clip);
        }

        #metric-modal .metric-chart .axis {
            shape-rendering: crispEdges;
        }

        #metric-modal .metric-chart .x.axis .domain {
            display: none;
        }

        #metric-modal .metric-chart .x.axis line {
            stroke: white;
            opacity: 0.4;
        }

        #metric-modal .metric-chart .context .x.axis line {
            display: none;
        }

        #metric-modal .metric-chart .y.axis .domain {
            display: none;
        }

        #metric-modal .metric-chart .y.axis.title {
            font-size: 13px;
            font-weight: 100;
        }

        #metric-modal .metric-chart .y.axis line {
            stroke: #565656;
            stroke-dasharray: 2, 2;
            stroke-opacity: 0.3;
        }

        #metric-modal .metric-chart .brush .extent {
            fill-opacity: .07;
            shape-rendering: crispEdges;
            clip-path: url(#clip);
        }

        #metric-modal .metric-chart rect.pane {
            cursor: move;
            fill: none;
            pointer-events: all;
        }

        /* brush handles  */
        #metric-modal .metric-chart .resize .handle {
            fill: #555;
        }

        #metric-modal .metric-chart .resize .handle-mini {
            fill: white;
            stroke-width: 1px;
            stroke: #555;
        }

        #metric-modal .metric-chart .scale_button {
            cursor: pointer;
        }

        #metric-modal .metric-chart .scale_button rect {
            fill: #eaeaea;
        }

        #metric-modal .metric-chart .scale_button:hover text {
            fill: #417DD6;
            transition: all 0.1s cubic-bezier(.25, .8, .25, 1);
        }

        #metric-modal .metric-chart text#displayDates {
            font-weight: bold;
        }

        #svgContainer {
            /* display: flex; */
            /* background-color: #fbfbfb; */
        }
        #parent {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 1rem;
        }
        #parent > div {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 25rem;
        }
        .card {
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
            /* width: 40%; */
            background-color: white;
            border-radius: 5px;
        }

        .card:hover {
            box-shadow: 10px 8px 16px 8px rgb(0 0 0 / 20%);
        }
        /* .topline {
            display: flex;
            justify-content: space-evenly;
            height: 50%;
        }

        .bottomline {
            display: flex;
            justify-content: space-evenly;
            height: 50%;
        } */

.tooltip {
  position: absolute;
  padding: 7px;
  font-size: 0.9em;
  pointer-events: none;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;

  -moz-box-shadow:    3px 3px 10px 0px rgba(0, 0, 0, 0.25);
  -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
  box-shadow:         3px 3px 10px 0px rgba(0, 0, 0, 0.25);
}

.tooltip p {
  margin: 0;
  padding: 0;
}

.tooltip table {
  margin: 0;
  padding: 0;
  border-collapse: collapse;
}
    </style>
</head>
<body>
<!-- <div class="header" style="background-color: antiquewhite; padding: 20px;
 display: inline-block;
 width: 100%;
 height: 100%;
 text-align: center;
 color: rgb(148, 1, 1);">
    <div id="child" class="child">
        <h1>WEATHER-ACCIDENT STATS</h1>
    </div>
</div> -->
<h2 style="text-align:center;">WEATHER-ACCIDENT STATS</h2>
<div id="svgContainer" class="svgContainer">
    <div id="parent">
        <div id="chloropleth" class="card"><h3 id="map-heading">United States Of America</h3>
                            <svg id="mysvg7" width="450" height="250"></svg>
                                        <svg id="mysvg8" width="130" height="230"></svg>

        </div>
        <div id="metric-modal" class="card"><h3>Accident Time Series</h3>
                    <svg id="mysvg6" width="320" height="300"></svg>
        </div>
        <div id="pcp" class="card"></div>
        <div class="card"><svg id="mysvg1" width="600" height="400"></svg></div>
        <div class="card" style="flex-direction: column;">
            <h3>Accident Distribution</h3>
            <div style="display: flex; justify-content: space-evenly;flex-direction: row;">
            <svg id="mysvg5" width="450" height="300"></svg>
            <svg id="mysvg4" width="350" height="300"></svg>
                </div>
        </div>
        <div class="card" style="flex-direction: column;">
                        <h3>Accident Distribution</h3>
            <div style="display: flex; justify-content: space-evenly;flex-direction: row;">
            <svg id="mysvg3" width="400" height="300"></svg>
            <svg id="mysvg2" width="350" height="300"></svg>
                </div>

        </div>
        <!-- <div style="
        border-style: solid;
        border-color:rgb(204, 178, 178); background-color:rgb(26, 24, 24);">
            <div style="display: flex; justify-content: space-evenly;">
                <svg id="mysvg2" width="350" height="300"></svg>
                <svg id="mysvg3" width="350" height="300"></svg>
            </div>
            <div style="display: flex; justify-content: space-evenly;">
                <svg id="mysvg4" width="350" height="300"></svg>
                <svg id="mysvg5" width="350" height="300"></svg>
            </div>
        </div> -->
    </div>
    <!-- <div id="parent2" style="width: 70%;">
        <div class="topline">
            <div id="chloropleth" style="border-style: solid;border-color: rgb(204, 178, 178);"></div>
            <div id="metric-modal" style="border-style:solid; border-color: rgb(204, 178, 178);"></div>
        </div>
        <div class="bottomline">
            <div id="pcp"
                 style="width: 40%;border-style: ridge; border-color:rgb(204, 178, 178); background-color:rgb(26, 24, 24);"></div>
            <div style="width: 60%;
            border-style: solid;
            border-color:rgb(204, 178, 178); background-color:rgb(26, 24, 24);">
                <div style="display: flex; justify-content: space-evenly;">
                    <svg id="mysvg2" width="350" height="300"></svg>
                    <svg id="mysvg3" width="350" height="300"></svg>
                </div>
                <div style="display: flex; justify-content: space-evenly;">
                    <svg id="mysvg4" width="350" height="300"></svg>
                    <svg id="mysvg5" width="350" height="300"></svg>
                </div>
            </div>
        </div>
    </div> -->
    <!-- <div id="parent1" style="width: 30%;">
        <div class="rightScreen">
            <svg id="mysvg1" width="500" height="600"></svg>
        </div>
    </div> -->
</div>
<script src="https://d3js.org/d3.v3.js"></script>
<script>
    var d3v3 = window.d3;
    window.d3 = null;
</script>
<script src="https://d3js.org/d3.v6.js"></script>
<script>
    var d3v6 = window.d3;
    window.d3 = null;
</script>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
<script src="https://bl.ocks.org/syntagmatic/raw/3341641/render-queue.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>

<script>
        var current_state=-1, time_update=false

    tooltip = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("opacity", 0);
    function updateRestOfChart() {

    fetch('/bar')
        .then(function (response) {
            return response.json()
        }).then(function (frequency_data) {
        const createChartBar = (myData) => {
            var svg = d3.select("#mysvg1"),
                margin = 200,
                width = svg.attr("width") - margin,
                height = svg.attr("height") - margin;

            // svg.append("rect")
            // .attr("width", "100%")
            // .attr("height", "100%")
            // .attr("fill", "aliceblue");
            svg
                .append("text")
                .attr("transform", "translate(100,0)")
                .attr("x", 50)
                .attr("y", 70)
                .attr("font-size", "24px")
                .text("States With Most Accidents");

            var xScale = d3.scaleBand().range([0, width]).padding(0.4);
            yScale = d3.scaleLinear().range([height, 0]);

            var g = svg
                .append("g")
                .attr("transform", "translate(" + 100 + "," + 100 + ")");


            xScale.domain(
                myData.map(function (d) {
                        return d.key;
                    }
                )
            );
            yScale.domain([
                0,
                d3.max(myData, function (d) {
                        return +d.value;
                    }
                )
            ]);

            g.append("g")
                //.attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale))
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                //.call(d3.axisBottom(xScale))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");

            g.append("g")
                .append("text")
                .attr("y", height + 50)
                .attr("x", width - 100)
                .attr("text-anchor", "end")
                .attr("stroke", "black")
                .text("STATE")

            g.append("g")
                .call(
                    d3
                        .axisLeft(yScale)
                        .tickFormat(function (d) {
                            return d;
                        })
                        .ticks(10)
                )
                .attr("transform", "translate(-1," + "0" + ")")
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "-5.1em")
                .attr("text-anchor", "end")
                .attr("stroke", "black")
                .text("FREQUENCY");

            g.selectAll(".bar")
                .data(myData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("fill", "#6695C4")
                .on("mouseover", onMouseOver)
                .on("mouseout", onMouseOut)
                .on("click", onMouseClick)
                .attr("x", function (d) {
                    return xScale(d.key);
                })
                .attr("y", function (d) {
                    return yScale(+d.value);
                })
                .attr("width", xScale.bandwidth())
                .attr("height", function (d) {
                    return height - yScale(+d.value);
                });
            if (myData.length===1){
                onMouseClick(myData[0])
            }

            function onMouseOver(d, i) {
                d3.select(this).attr('class', 'highlight');
                d3.select(this)
                    .attr("fill","#2468AD")
                    .transition()
                    .duration(200)
                    .attr('width', xScale.bandwidth() + 2.5)
                    .attr("y", function () {
                        return yScale(+d.value) - 10;
                    })
                    .attr("height", function () {
                        return height - yScale(+d.value) + 10;
                    });

                g.append("text")
                    .attr('class', 'val')
                    .attr('x', function () {
                        //console.log(xScale(d.key));
                        return xScale(d.key);
                    })
                    .attr('y', function () {
                        return yScale(+d.value) - 20;
                    })
                    .text(function () {
                        return [+d.value];
                    })
                    .attr("fill","#2468AD");
            }

            function onMouseOut(d, i) {
                d3.select(this).attr('class', 'bar');
                d3.select(this)
                    .attr("fill","#6695C4")
                    .transition()
                    .duration(200)
                    .attr("x", function (d) {
                        return xScale(d.key);
                    })
                    .attr('width', xScale.bandwidth())
                    .attr("y", function () {
                        return yScale(+d.value);
                    })
                    .attr("height", function () {
                        return height - yScale(+d.value);
                    });

                d3.selectAll('.val')
                    .remove()
            }

            function onMouseClick(d, i) {
                fetch('/county/' + d.key)
                    .then(function (response) {
                        return response.json()
                    }).then(function (data) {
                    const createCountyBar = (county_data) => {
                        console.log(county_data)
                        var svg = d3.select("#mysvg1"),
                            margin = 200,
                            width = svg.attr("width") - margin,
                            height = svg.attr("height") - margin;

                        // svg.append("rect")
                        // .attr("width", "100%")
                        // .attr("height", "100%")
                        // .attr("fill", "aliceblue");
                        svg
                            .append("text")
                            .attr("transform", "translate(100,0)")
                            .attr("x", 50)
                            .attr("y", 50)
                            .attr("font-size", "24px")
                            .text("Counties With Most Accidents");

                        var xScale_county = d3.scaleBand().range([0, width]).padding(0.4);
                        yScale_county = d3.scaleLinear().range([height, 0]);

                        var g = svg
                            .append("g")
                            .attr("transform", "translate(" + 100 + "," + 100 + ")");


                        xScale_county.domain(
                            county_data.map(function (d) {
                                    return d.key;
                                }
                            )
                        );
                        yScale_county.domain([
                            0,
                            d3.max(county_data, function (d) {
                                    return +d.value;
                                }
                            )
                        ]);

                        g.append("g")
                            //.attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(xScale_county))
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            //.call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-65)");

                        g.append("g")
                            .append("text")
                            .attr("y", height + 80)
                            .attr("x", width - 100)
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("COUNTIES")

                        g.append("g")
                            .call(
                                d3
                                    .axisLeft(yScale_county)
                                    .tickFormat(function (d) {
                                        return d;
                                    })
                                    .ticks(10)
                            )
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", "-5.1em")
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("FREQUENCY");

                        g.selectAll(".bar")
                            .data(county_data)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#6695C4")
                            .on("mouseover", onMouseOver_county)
                            .on("mouseout", onMouseOut_county)
                            .on("click", onMouseClick_county)
                            .attr("x", function (d) {
                                return xScale_county(d.key);
                            })
                            .attr("y", function (d) {
                                return yScale_county(+d.value);
                            })
                            .attr("width", xScale_county.bandwidth())
                            .attr("height", function (d) {
                                return height - yScale_county(+d.value);
                            });

                        function onMouseOver_county(d, i) {
                            d3.select(this).attr('class', 'highlight');
                            d3.select(this)
                                .attr("fill", "#2468AD")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_county.bandwidth() + 5)
                                .attr("y", function () {
                                    return yScale_county(+d.value) - 10;
                                })
                                .attr("height", function () {
                                    return height - yScale_county(+d.value) + 10;
                                });

                            g.append("text")
                                .attr('class', 'val')
                                .attr('x', function () {
                                    //console.log(xScale(d.key));
                                    return xScale_county(d.key);
                                })
                                .attr('y', function () {
                                    return yScale_county(+d.value) - 20;
                                })
                                .text(function () {
                                    return [+d.value];
                                })
                                .attr("fill", "#2468AD");
                        }

                        function onMouseOut_county(d, i) {
                            d3.select(this).attr('class', 'bar');
                            d3.select(this)
                                .attr("fill", "#6695C4")
                                .transition()
                                .duration(200)
                                .attr("x", function (d) {
                                    return xScale_county(d.key);
                                })
                                .attr('width', xScale_county.bandwidth())
                                .attr("y", function () {
                                    return yScale_county(+d.value);
                                })
                                .attr("height", function () {
                                    return height - yScale_county(+d.value);
                                });

                            d3.selectAll('.val')
                                .remove()
                        }

                        function onMouseClick_county(d, i) {
                            document.getElementById("mysvg1").innerHTML = '';
                            createChartBar(frequency_data)
                        }

                    };
                    document.getElementById("mysvg1").innerHTML = '';
                    createCountyBar(data)
                });
            }
        };
        document.getElementById("mysvg1").innerHTML = '';
        createChartBar(frequency_data)

    });

    fetch('/bar_state_year')
        .then(function (response) {
            return response.json()
        }).then(function (year_data) {
                                const createYearChartBar = (id, yearData, Name) => {
                        var svg = d3.select(id),
                            margin = 200,
                            width = svg.attr("width") - margin,
                            height = svg.attr("height") - margin;

                        // svg.append("rect")
                        // .attr("width", "100%")
                        // .attr("height", "100%")
                        // .attr("fill", "aliceblue");
                        svg
                            .append("text")
                            .attr("transform", "translate(100,0)")
                            .attr("x", 30)
                            .attr("y", 50)
                            .attr("font-size", "14px")
                            .text(Name);

                        var xScale_year = d3.scaleBand().range([0, width]).padding(0.4);
                        yScale_year = d3.scaleLinear().range([height, 0]);

                        var g = svg
                            .append("g")
                            .attr("transform", "translate(" + 100 + "," + 100 + ")");


                        xScale_year.domain(
                            yearData.map(function (d) {
                                    return d.key;
                                }
                            )
                        );
                        yScale_year.domain([
                            0,
                            d3.max(yearData, function (d) {
                                    return +d.value;
                                }
                            )
                        ]);

                        g.append("g")
                            //.attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(xScale_year))
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            //.call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-65)");

                        g.append("g")
                            .append("text")
                            .attr("y", height + 80)
                            .attr("x", width - 100)
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text(Name)

                        g.append("g")
                            .call(
                                d3
                                    .axisLeft(yScale_year)
                                    .tickFormat(function (d) {
                                        return d;
                                    })
                                    .ticks(10)
                            )
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", "-5.1em")
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("FREQUENCY");

                        g.selectAll(".bar")
                            .data(yearData)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#6695C4")
                            .on("mouseover", onMouseOver_year)
                            .on("mouseout", onMouseOut_year)
                            .attr("x", function (d) {
                                return xScale_year(d.key);
                            })
                            .attr("y", function (d) {
                                return yScale_year(+d.value);
                            })
                            .attr("width", xScale_year.bandwidth())
                            .attr("height", function (d) {
                                return height - yScale_year(+d.value);
                            });

                        function onMouseOver_year(d, i) {
                            d3.select(this).attr('class', 'highlight');
                            d3.select(this)
                                .attr("fill", "#2468AD")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_year.bandwidth() + 2.5)
                                .attr("y", function () {
                                    return yScale_year(+d.value) - 10;
                                })
                                .attr("height", function () {
                                    return height - yScale_year(+d.value) + 10;
                                });

                            g.append("text")
                                .attr('class', 'val')
                                .attr("fill", "#2468AD")
                                .attr('x', function () {
                                    return xScale_year(d.key);
                                })
                                .attr('y', function () {
                                    return yScale_year(+d.value) - 20;
                                })
                                .text(function () {
                                    return [+d.value];
                                });
                        }

                        function onMouseOut_year(d, i) {
                            d3.select(this).attr('class', 'bar');
                            d3.select(this)
                                .attr("fill", "#6695C4")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_year.bandwidth())
                                .attr("y", function () {
                                    return yScale_year(+d.value);
                                })
                                .attr("height", function () {
                                    return height - yScale_year(+d.value);
                                });

                            d3.selectAll('.val')
                                .remove()
                        }
                    };
                    document.getElementById("mysvg2").innerHTML = '';
                    createYearChartBar("#mysvg2", year_data, "YEAR")

    });
        fetch('/bar_state_month')
            .then(function (response) {
                return response.json()
            }).then(function (month_data) {
                const createMonthChartBar = (id, monthData, Name) => {
                        var svg = d3.select(id),
                            margin = 200,
                            width = svg.attr("width") - margin,
                            height = svg.attr("height") - margin;

                        // svg.append("rect")
                        // .attr("width", "100%")
                        // .attr("height", "100%")
                        // .attr("fill", "aliceblue");
                        svg
                            .append("text")
                            .attr("transform", "translate(100,0)")
                            .attr("x", 30)
                            .attr("y", 50)
                            .attr("font-size", "14px")
                            .text(Name);

                        var xScale_month = d3.scaleBand().range([0, width]).padding(0.4);
                        yScale_month = d3.scaleLinear().range([height, 0]);

                        var g = svg
                            .append("g")
                            .attr("transform", "translate(" + 100 + "," + 100 + ")");


                        xScale_month.domain(
                            monthData.map(function (d) {
                                    return d.key;
                                }
                            )
                        );
                        yScale_month.domain([
                            0,
                            d3.max(monthData, function (d) {
                                    return +d.value;
                                }
                            )
                        ]);

                        g.append("g")
                            //.attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(xScale_month))
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            //.call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-65)");

                        g.append("g")
                            .append("text")
                            .attr("y", height + 80)
                            .attr("x", width - 100)
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text(Name)

                        g.append("g")
                            .call(
                                d3
                                    .axisLeft(yScale_month)
                                    .tickFormat(function (d) {
                                        return d;
                                    })
                                    .ticks(10)
                            )
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", "-5.1em")
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("FREQUENCY");

                        g.selectAll(".bar")
                            .data(monthData)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#6695C4")
                            .on("mouseover", onMouseOver_month)
                            .on("mouseout", onMouseOut_month)
                            .attr("x", function (d) {
                                return xScale_month(d.key);
                            })
                            .attr("y", function (d) {
                                return yScale_month(+d.value);
                            })
                            .attr("width", xScale_month.bandwidth())
                            .attr("height", function (d) {
                                return height - yScale_month(+d.value);
                            });

                        function onMouseOver_month(d, i) {
                            d3.select(this).attr('class', 'highlight');
                            d3.select(this)
                                .attr("fill", "#2468AD")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_month.bandwidth() + 2.5)
                                .attr("y", function () {
                                    return yScale_month(+d.value) - 10;
                                })
                                .attr("height", function () {
                                    return height - yScale_month(+d.value) + 10;
                                });

                            g.append("text")
                                .attr('class', 'val')
                                .attr("fill", "#2468AD")
                                .attr('x', function () {
                                    return xScale_month(d.key);
                                })
                                .attr('y', function () {
                                    return yScale_month(+d.value) - 20;
                                })
                                .text(function () {
                                    return [+d.value];
                                });
                        }

                        function onMouseOut_month(d, i) {
                            d3.select(this).attr('class', 'bar');
                            d3.select(this)
                                .attr("fill", "#6695C4")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_month.bandwidth())
                                .attr("y", function () {
                                    return yScale_month(+d.value);
                                })
                                .attr("height", function () {
                                    return height - yScale_month(+d.value);
                                });

                            d3.selectAll('.val')
                                .remove()
                        }
                    };

                    document.getElementById("mysvg3").innerHTML = '';
                    createMonthChartBar("#mysvg3", month_data, "MONTH")
        });
            fetch('/bar_state_day')
                .then(function (response) {
                    return response.json()
                }).then(function (day_data) {
const createDayChartBar = (id, dayData, Name) => {
                        var svg = d3.select(id),
                            margin = 200,
                            width = svg.attr("width") - margin,
                            height = svg.attr("height") - margin;

                        // svg.append("rect")
                        // .attr("width", "100%")
                        // .attr("height", "100%")
                        // .attr("fill", "aliceblue");
                        svg
                            .append("text")
                            .attr("transform", "translate(100,0)")
                            .attr("x", 30)
                            .attr("y", 50)
                            .attr("font-size", "14px")
                            .text(Name);

                        var xScale_day = d3.scaleBand().range([0, width]).padding(0.4);
                        yScale_day = d3.scaleLinear().range([height, 0]);

                        var g = svg
                            .append("g")
                            .attr("transform", "translate(" + 100 + "," + 100 + ")");


                        xScale_day.domain(
                            dayData.map(function (d) {
                                    return d.key;
                                }
                            )
                        );
                        yScale_day.domain([
                            0,
                            d3.max(dayData, function (d) {
                                    return +d.value;
                                }
                            )
                        ]);

                        g.append("g")
                            //.attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(xScale_day))
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            //.call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-65)");

                        g.append("g")
                            .append("text")
                            .attr("y", height + 80)
                            .attr("x", width - 100)
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text(Name)

                        g.append("g")
                            .call(
                                d3
                                    .axisLeft(yScale_day)
                                    .tickFormat(function (d) {
                                        return d;
                                    })
                                    .ticks(10)
                            )
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", "-5.1em")
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("FREQUENCY");

                        g.selectAll(".bar")
                            .data(dayData)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#6695C4")
                            .on("mouseover", onMouseOver_day)
                            .on("mouseout", onMouseOut_day)
                            .attr("x", function (d) {
                                return xScale_day(d.key);
                            })
                            .attr("y", function (d) {
                                return yScale_day(+d.value);
                            })
                            .attr("width", xScale_day.bandwidth())
                            .attr("height", function (d) {
                                return height - yScale_day(+d.value);
                            });

                        function onMouseOver_day(d, i) {
                            d3.select(this).attr('class', 'highlight');
                            d3.select(this)
                                .attr("fill", "#2468AD")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_day.bandwidth() + 2.5)
                                .attr("y", function () {
                                    return yScale_day(+d.value) - 10;
                                })
                                .attr("height", function () {
                                    return height - yScale_day(+d.value) + 10;
                                });

                            g.append("text")
                                .attr('class', 'val')
                                .attr("fill", "#2468AD")
                                .attr('x', function () {
                                    return xScale_day(d.key);
                                })
                                .attr('y', function () {
                                    return yScale_day(+d.value) - 20;
                                })
                                .text(function () {
                                    return [+d.value];
                                });
                        }

                        function onMouseOut_day(d, i) {
                            d3.select(this).attr('class', 'bar');
                            d3.select(this)
                                .attr("fill", "#6695C4")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_day.bandwidth())
                                .attr("y", function () {
                                    return yScale_day(+d.value);
                                })
                                .attr("height", function () {
                                    return height - yScale_day(+d.value);
                                });

                            d3.selectAll('.val')
                                .remove()
                        }
                    };

                    document.getElementById("mysvg4").innerHTML = '';
                    createDayChartBar("#mysvg4", day_data, "Days")
            });
                fetch('/bar_state_hour')
                    .then(function (response) {
                        return response.json()
                    }).then(function (hour_data) {




                    const createHourChartBar = (id, timeData, Name) => {
                        var svg = d3.select(id),
                            margin = 200,
                            width = svg.attr("width") - margin,
                            height = svg.attr("height") - margin;

                        // svg.append("rect")
                        // .attr("width", "100%")
                        // .attr("height", "100%")
                        // .attr("fill", "aliceblue");
                        svg
                            .append("text")
                            .attr("transform", "translate(100,0)")
                            .attr("x", 30)
                            .attr("y", 50)
                            .attr("font-size", "14px")
                            .text(Name);

                        var xScale_time = d3.scaleBand().range([0, width]).padding(0.4);
                        yScale_time = d3.scaleLinear().range([height, 0]);

                        var g = svg
                            .append("g")
                            .attr("transform", "translate(" + 100 + "," + 100 + ")");


                        xScale_time.domain(
                            timeData.map(function (d) {
                                    return d.key;
                                }
                            )
                        );
                        yScale_time.domain([
                            0,
                            d3.max(timeData, function (d) {
                                    return +d.value;
                                }
                            )
                        ]);

                        g.append("g")
                            //.attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(xScale_time))
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            //.call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .style("text-anchor", "end")
                            .attr("dx", "-.8em")
                            .attr("dy", ".15em")
                            .attr("transform", "rotate(-65)");

                        g.append("g")
                            .append("text")
                            .attr("y", height + 80)
                            .attr("x", width - 100)
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text(Name)

                        g.append("g")
                            .call(
                                d3
                                    .axisLeft(yScale_time)
                                    .tickFormat(function (d) {
                                        return d;
                                    })
                                    .ticks(10)
                            )
                            .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", "-5.1em")
                            .attr("text-anchor", "end")
                            .attr("stroke", "black")
                            .text("FREQUENCY");

                        g.selectAll(".bar")
                            .data(timeData)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", "#6695C4")
                            .on("mouseover", onMouseOver_time)
                            .on("mouseout", onMouseOut_time)
                            .attr("x", function (d) {
                                return xScale_time(d.key);
                            })
                            .attr("y", function (d) {
                                return yScale_time(+d.value);
                            })
                            .attr("width", xScale_time.bandwidth())
                            .attr("height", function (d) {
                                return height - yScale_time(+d.value);
                            });

                        function onMouseOver_time(d, i) {
                            d3.select(this).attr('class', 'highlight');
                            d3.select(this)
                                .attr("fill", "#2468AD")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_time.bandwidth() + 2.5)
                                .attr("y", function () {
                                    return yScale_time(+d.value) - 10;
                                })
                                .attr("height", function () {
                                    return height - yScale_time(+d.value) + 10;
                                });

                            g.append("text")
                                .attr('class', 'val')
                                .attr("fill", "#2468AD")
                                .attr('x', function () {
                                    return xScale_time(d.key);
                                })
                                .attr('y', function () {
                                    return yScale_time(+d.value) - 20;
                                })
                                .text(function () {
                                    return [+d.value];
                                });
                        }

                        function onMouseOut_time(d, i) {
                            d3.select(this).attr('class', 'bar');
                            d3.select(this)
                                .attr("fill", "#6695C4")
                                .transition()
                                .duration(200)
                                .attr('width', xScale_time.bandwidth())
                                .attr("y", function () {
                                    return yScale_time(+d.value);
                                })
                                .attr("height", function () {
                                    return height - yScale_time(+d.value);
                                });

                            d3.selectAll('.val')
                                .remove()
                        }
                    };
                    document.getElementById("mysvg5").innerHTML = '';
                    createHourChartBar("#mysvg5", hour_data, "HOURS")
                });
    fetch('/pcp')
        .then(function (response) {
            return response.json()
        }).then(function (text) {

        const createPCP = (data) => {
            var margin = {top: 50, right: 50, bottom: 50, left: 50},
                width = 650 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

            var color = d3.scaleOrdinal()
                .range(["#5DA5B3", "#D58323", "#DD6CA7", "#54AF52", "#8C92E8", "#E15E5A", "#725D82", "#776327", "#50AB84", "#954D56", "#AB9C27", "#517C3F", "#9D5130", "#357468", "#5E9ACF", "#C47DCB", "#7D9E33", "#DB7F85", "#BA89AD", "#4C6C86", "#B59248", "#D8597D", "#944F7E", "#D67D4B", "#8F86C2"]);


            var dimensions = [
                {
                    name: "Severity",
                    scale: d3.scalePoint().range([height, 0]),
                    type: "string"
                },
                {
                    name: "Temperature(F)",
                    scale: d3.scaleLinear().range([height, 0]),
                    type: "number"
                },
                {
                    name: "Humidity(%)",
                    scale: d3.scaleLinear().range([height, 0]),
                    type: "number"
                },
                {
                    name: "Visibility(mi)",
                    scale: d3.scaleLinear().range([height, 0]),
                    type: "number"
                },
                {
                    name: "Weather_Condition",
                    scale: d3.scalePoint().range([0, height]),
                    type: "string"
                },
                {
                    name: "Wind_Speed(mph)",
                    scale: d3.scaleLinear().range([height, 0]),
                    type: "number"
                }
            ];

            var x = d3.scalePoint().domain(dimensions.map(function (d) {
                    return d.name;
                })).range([0, width]),
                y = {},
                dragging = {};

            for (i in dimensions) {
                var name = dimensions[i].name
                y[name] = d3.scaleLinear()
                    .domain(d3.extent(data, function (d) {
                        return +d[name];
                    }))
                    .range([height, 0])
            }

            var line = d3.line(),
                axis = d3.axisLeft(),
                background,
                foreground;

            var svg = d3.select("#pcp").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            dimensions.forEach(function (dimension) {
                dimension.scale.domain(dimension.type === "number"
                    ? d3.extent(data, function (d) {
                        return +d[dimension.name];
                    })
                    : data.map(function (d) {
                        return d[dimension.name];
                    }).sort());
            });

            background = svg.append("g")
                .attr("class", "background")
                .selectAll("path")
                .data(data)
                .enter().append("path")
                .attr("d", path);

            foreground = svg.append("g")
                .attr("class", "foreground")
                .selectAll("path")
                .data(data)
                .enter().append("path")
                .attr("class", function (d) {
                    return "line " + d.Severity
                })
                .attr("d", path)
                .style("stroke", function (d) {
                    return (color(d.Severity))
                })
                .style("stroke-width", 1)
                .style("opacity", 0.5);

            var g = svg.selectAll(".dimension")
                .data(dimensions)
                .enter().append("g")
                .attr("class", "dimension")
                .attr("transform", function (d) {
                    return "translate(" + x(d.name) + ")";
                })
                .call(d3.drag()
                    .subject(subject)
                    .on("start", function (d) {
                        dragging[d.name] = x(d.name);
                        background.attr("visibility", "hidden");
                    })
                    .on("drag", function (d) {
                        dragging[d.name] = Math.min(width, Math.max(0, d3.event.x));
                        foreground.attr("d", path);
                        dimensions.sort(function (a, b) {
                            return position(a) - position(b);
                        });
                        x.domain(dimensions.map(function (d) {
                            return d.name;
                        }));
                        g.attr("transform", function (d) {
                            return "translate(" + position(d) + ")";
                        })
                    })
                    .on("end", function (d) {
                        delete dragging[d.name];
                        transition(d3.select(this)).attr("transform", "translate(" + x(d.name) + ")");
                        transition(foreground).attr("d", path);
                        background
                            .attr("d", path)
                            .transition()
                            .delay(500)
                            .duration(0)
                            .attr("visibility", null);
                    })
                );

            function subject(d) {
                return {x: x(d.name)};
            }

            g.append("g")
                .attr("class", "axis")
                .each(function (d) {
                    d3.select(this).call(d3.axisLeft(d.scale));
                })
                .append("text")
                .style("text-anchor", "middle")
                .attr("y", -9)
                .text(function (d) {
                    return d.name;
                })
                .style("fill", "black")
                .attr("class", "axis");

            g.append("g")
                .attr("class", "brush")
                .each(function (d) {
                    d3.select(this).call(
                        y[d.name].brush = d3.brushY()
                            .extent([[-10, 0], [10, height]])
                            .on("start", brushstart)
                            .on("brush", brush)
                            .on("end", brush)
                    )
                })
                .selectAll("rect")
                .attr("x", -8)
                .attr("width", 16);


            function position(d) {
                var v = dragging[d.name];
                return v == null ? x(d.name) : v;
            }

            function transition(g) {
                return g.transition().duration(500);
            }

            function path(d) {
                return line(dimensions.map(function (dimension) {
                    var v = dragging[dimension.name];
                    var tx = v == null ? x(dimension.name) : v;
                    return [tx, dimension.scale(d[dimension.name])];
                }));
            }

            function brushstart() {
                d3.event.sourceEvent.stopPropagation();
            }

            function brush() {
                var actives = [];
                svg.selectAll(".brush")
                    .filter(function (d) {
                        return d3.brushSelection(this);
                    })
                    .each(function (key) {
                        actives.push({
                            dimension: key.name,
                            extent: d3.brushSelection(this)
                        });
                    });
                if (actives.length === 0) {
                    foreground.style("display", null);
                } else {
                    foreground.style("display", function (d) {
                        return actives.every(function (brushObj) {
                            return brushObj.extent[0] <= y[brushObj.dimension](d[brushObj.dimension]) && y[brushObj.dimension](d[brushObj.dimension]) <= brushObj.extent[1];
                        }) ? null : "none";
                    });
                }

            }
        };
        document.getElementById("pcp").innerHTML = '<h3>Parallel Axis Plot</h3>';
        createPCP(text);
    });
    }

    function updateTimeSeries(){
        // example data
    fetch('/time_series')
        .then(function (response) {
            return response.json()
        }).then(function (data) {


// example data
        var metricName = "views";
        var metricCount = data.freq;
        var metricMonths = data.times;
        var optwidth = 410;
        var optheight = 310;


        /*
        * ========================================================================
        *  Prepare data
        * ========================================================================
        */

// Combine the months and count array to make "data"
        var dataset = [];
        for (var i = 0; i < metricCount.length; i++) {
            var obj = {count: metricCount[i], month: metricMonths[i]};
            dataset.push(obj);
        }

// format month as a date
        dataset.forEach(function (d) {
            d.month = d3v3.time.format("%Y-%m").parse(d.month);
        });

// sort dataset by month
        dataset.sort(function (x, y) {
            return d3v3.ascending(x.month, y.month);
        });


        /*
        * ========================================================================
        *  sizing
        * ========================================================================
        */

        /* === Focus chart === */

        var margin = {top: 20, right: 30, bottom: 100, left: 20},
            width = optwidth - margin.left - margin.right,
            height = optheight - margin.top - margin.bottom;

        /* === Context chart === */

        var margin_context = {top: 220, right: 30, bottom: 20, left: 20},
            height_context = 30;

        /*
        * ========================================================================
        *  x and y coordinates
        * ========================================================================
        */

// the date range of available data:
        var dataXrange = d3v3.extent(dataset, function (d) {
            return d.month;
        });
        var dataYrange = [0, d3v3.max(dataset, function (d) {
            return d.count;
        })];

// maximum date range allowed to display
        var mindate = dataXrange[0],  // use the range of the data
            maxdate = dataXrange[1];

        var DateFormat = d3v3.time.format("%b %Y");

        var dynamicDateFormat = timeFormat([
            [d3v3.time.format("%Y"), function () {
                return true;
            }],// <-- how to display when Jan 1 YYYY
            [d3v3.time.format("%b %Y"), function (d) {
                return d.getMonth();
            }],
            [function () {
                return "";
            }, function (d) {
                return d.getDate() != 1;
            }]
        ]);

// var dynamicDateFormat =  timeFormat([
//     [d3v3.time.format("%Y"), function() { return true; }],
//     [d3v3.time.format("%b"), function(d) { return d.getMonth(); }],
//     [function(){return "";}, function(d) { return d.getDate() != 1; }]
// ]);

        /* === Focus Chart === */

        var x = d3v3.time.scale()
            .range([0, (width)])
            .domain(dataXrange);

        var y = d3v3.scale.linear()
            .range([height, 0])
            .domain(dataYrange);

        var xAxis = d3v3.svg.axis()
            .scale(x)
            .orient("bottom")
            .tickSize(-(height))
            .ticks(customTickFunction)
            .tickFormat(dynamicDateFormat);

        var yAxis = d3v3.svg.axis()
            .scale(y)
            .ticks(4)
            .tickSize(-(width))
            .orient("right");

        /* === Context Chart === */

        var x2 = d3v3.time.scale()
            .range([0, width])
            .domain([mindate, maxdate]);

        var y2 = d3v3.scale.linear()
            .range([height_context, 0])
            .domain(y.domain());

        var xAxis_context = d3v3.svg.axis()
            .scale(x2)
            .orient("bottom")
            .ticks(customTickFunction)
            .tickFormat(dynamicDateFormat);

        /*
        * ========================================================================
        *  Plotted line and area variables
        * ========================================================================
        */

        /* === Focus Chart === */

        var line = d3v3.svg.line()
            .x(function (d) {
                return x(d.month);
            })
            .y(function (d) {
                return y(d.count);
            });

        var area = d3v3.svg.area()
            .x(function (d) {
                return x(d.month);
            })
            .y0((height))
            .y1(function (d) {
                return y(d.count);
            });

        /* === Context Chart === */

        var area_context = d3v3.svg.area()
            .x(function (d) {
                return x2(d.month);
            })
            .y0((height_context))
            .y1(function (d) {
                return y2(d.count);
            });

        var line_context = d3v3.svg.line()
            .x(function (d) {
                return x2(d.month);
            })
            .y(function (d) {
                return y2(d.count);
            });

        /*
        * ========================================================================
        *  Variables for brushing and zooming behaviour
        * ========================================================================
        */

        var brush = d3v3.svg.brush()
            .x(x2)
            .on("brush", brushed)
            .on("brushend", brushend);

        var zoom = d3v3.behavior.zoom()
            .on("zoom", draw)
            .on("zoomend", brushend);

        /*
        * ========================================================================
        *  Define the SVG area ("vis") and append all the layers
        * ========================================================================
        */

// === the main components === //
        document.getElementById("mysvg6").innerHTML = '';

        var vis = d3v3.select("#mysvg6")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "metric-chart"); // CB -- "line-chart" -- CB //

        vis.append("defs").append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height);
        // clipPath is used to keep line and area from moving outside of plot area when user zooms/scrolls/brushes

        var context = vis.append("g")
            .attr("class", "context")
            .attr("transform", "translate(" + margin_context.left + "," + margin_context.top + ")");

        var focus = vis.append("g")
            .attr("class", "focus")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var rect = vis.append("svg:rect")
            .attr("class", "pane")
            .attr("width", width)
            .attr("height", height)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(zoom)
            .call(draw);

// === current date range text & zoom buttons === //

        var display_range_group = vis.append("g")
            .attr("id", "buttons_group")
            .attr("transform", "translate(" + 0 + "," + 0 + ")");

        var expl_text = display_range_group.append("text")
            .text("Showing data from: ")
            .style("text-anchor", "start")
            .attr("transform", "translate(" + 0 + "," + 10 + ")");

        display_range_group.append("text")
            .attr("id", "displayDates")
            .text(DateFormat(dataXrange[0]) + " - " + DateFormat(dataXrange[1]))
            .style("text-anchor", "start")
            .attr("transform", "translate(" + 82 + "," + 10 + ")");

        var expl_text = display_range_group.append("text")
            .text("Zoom to: ")
            .style("text-anchor", "start")
            .attr("transform", "translate(" + 180 + "," + 10 + ")");

// === the zooming/scaling buttons === //

        var button_width = 40;
        var button_height = 14;

// don't show year button if < 1 year of data
        var dateRange = dataXrange[1] - dataXrange[0],
            ms_in_year = 31540000000;

        if (dateRange < ms_in_year) {
            var button_data = ["month", "data"];
        } else {
            var button_data = ["year", "month", "data"];
        }
        ;

        var button = display_range_group.selectAll("g")
            .data(button_data)
            .enter().append("g")
            .attr("class", "scale_button")
            .attr("transform", function (d, i) {
                return "translate(" + (220 + i * button_width + i * 10) + ",0)";
            })
            .on("click", scaleDate);

        button.append("rect")
            .attr("width", button_width)
            .attr("height", button_height)
            .attr("rx", 1)
            .attr("ry", 1);

        button.append("text")
            .attr("dy", (button_height / 2 + 3))
            .attr("dx", button_width / 2)
            .style("text-anchor", "middle")
            .text(function (d) {
                return d;
            });

        /* === focus chart === */

        focus.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .attr("transform", "translate(" + (width) + ", 0)");

        focus.append("path")
            .datum(dataset)
            .attr("class", "area")
            .attr("d", area);

        focus.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        focus.append("path")
            .datum(dataset)
            .attr("class", "line")
            .attr("d", line);

        /* === context chart === */

        context.append("path")
            .datum(dataset)
            .attr("class", "area")
            .attr("d", area_context);

        context.append("path")
            .datum(dataset)
            .attr("class", "line")
            .attr("d", line_context);

        context.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height_context + ")")
            .call(xAxis_context);

        /* === brush (part of context chart)  === */

        var brushg = context.append("g")
            .attr("class", "x brush")
            .call(brush);

        brushg.selectAll(".extent")
            .attr("y", -6)
            .attr("height", height_context + 8);
        // .extent is the actual window/rectangle showing what's in focus

        brushg.selectAll(".resize")
            .append("rect")
            .attr("class", "handle")
            .attr("transform", "translate(0," + -3 + ")")
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("height", height_context + 6)
            .attr("width", 3);

        brushg.selectAll(".resize")
            .append("rect")
            .attr("class", "handle-mini")
            .attr("transform", "translate(-2,8)")
            .attr('rx', 3)
            .attr('ry', 3)
            .attr("height", (height_context / 2))
            .attr("width", 7);
        // .resize are the handles on either size
        // of the 'window' (each is made of a set of rectangles)

        /* === y axis title === */

        vis.append("text")
            .attr("class", "y axis title")
            //.text("Monthly " + this.metricName)
            .attr("x", (-(height / 2)))
            .attr("y", 0)
            .attr("dy", "1em")
            .attr("transform", "rotate(-90)")
            .style("text-anchor", "middle");

// allows zooming before any brush action
        zoom.x(x);

        /*
        * ========================================================================
        *  Functions
        * ========================================================================
        */

// === tick/date formatting functions ===
// from: https://stackoverflow.com/questions/20010864/d3v3-axis-labels-become-too-fine-grained-when-zoomed-in

        function timeFormat(formats) {
            return function (date) {
                var i = formats.length - 1, f = formats[i];
                while (!f[1](date)) f = formats[--i];
                return f[0](date);
            };
        };

        function customTickFunction(t0, t1, dt) {
            var labelSize = 42; //
            var maxTotalLabels = Math.floor(width / labelSize);

            function step(date, offset) {
                date.setMonth(date.getMonth() + offset);
            }

            var time = d3v3.time.month.ceil(t0), times = [], monthFactors = [1, 3, 4, 12];

            while (time < t1) times.push(new Date(+time)), step(time, 1);
            var timesCopy = times;
            var i;
            for (i = 0; times.length > maxTotalLabels; i++)
                times = _.filter(timesCopy, function (d) {
                    return (d.getMonth()) % monthFactors[i] == 0;
                });

            return times;
        };

// === brush and zoom functions ===

        function brushed() {
            x.domain(brush.empty() ? x2.domain() : brush.extent());
            focus.select(".area").attr("d", area);
            focus.select(".line").attr("d", line);
            focus.select(".x.axis").call(xAxis);
            // Reset zoom scale's domain
            zoom.x(x);
            updateDisplayDates();
            setYdomain();

        };

        function draw() {
            setYdomain();
            focus.select(".area").attr("d", area);
            focus.select(".line").attr("d", line);
            focus.select(".x.axis").call(xAxis);
            //focus.select(".y.axis").call(yAxis);
            // Force changing brush range
            brush.extent(x.domain());
            vis.select(".brush").call(brush);
            // and update the text showing range of dates.
            updateDisplayDates();
        };

        function brushend() {
// when brush stops moving:
            var _data = {start_time: brush.extent()[1], end_time: brush.extent()[0]}
            time_update=true
            fetch('/update/time', {
                      method: "POST",
                      body: JSON.stringify(_data),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response){
                        updateRestOfChart()
                        updateChloropleth()
                    });
            // check whether chart was scrolled out of bounds and fix,
            var b = brush.extent();
            var out_of_bounds = brush.extent().some(function (e) {
                return e < mindate | e > maxdate;
            });
            if (out_of_bounds) {
                b = moveInBounds(b)
            }
            ;

        };

        function updateDisplayDates() {

            var b = brush.extent();
            // update the text that shows the range of displayed dates
            var localBrushDateStart = (brush.empty()) ? DateFormat(dataXrange[0]) : DateFormat(b[0]),
                localBrushDateEnd = (brush.empty()) ? DateFormat(dataXrange[1]) : DateFormat(b[1]);

            // Update start and end dates in upper right-hand corner
            d3v3.select("#displayDates")
                .text(localBrushDateStart == localBrushDateEnd ? localBrushDateStart : localBrushDateStart + " - " + localBrushDateEnd);
        };

        function moveInBounds(b) {
// move back to boundaries if user pans outside min and max date.

            var ms_in_year = 31536000000,
                brush_start_new,
                brush_end_new;

            if (b[0] < mindate) {
                brush_start_new = mindate;
            } else if (b[0] > maxdate) {
                brush_start_new = new Date(maxdate.getTime() - ms_in_year);
            } else {
                brush_start_new = b[0];
            }
            ;

            if (b[1] > maxdate) {
                brush_end_new = maxdate;
            } else if (b[1] < mindate) {
                brush_end_new = new Date(mindate.getTime() + ms_in_year);
            } else {
                brush_end_new = b[1];
            }
            ;

            brush.extent([brush_start_new, brush_end_new]);

            brush(d3v3.select(".brush").transition());
            brushed();
            draw();

            return (brush.extent())
        };

        function setYdomain() {
// this function dynamically changes the y-axis to fit the data in focus

            // get the min and max date in focus
            var xleft = new Date(x.domain()[0]);
            var xright = new Date(x.domain()[1]);

            // a function that finds the nearest point to the right of a point
            var bisectDate = d3v3.bisector(function (d) {
                return d.month;
            }).right;

            // get the y value of the line at the left edge of view port:
            var iL = bisectDate(dataset, xleft);

            if (dataset[iL] !== undefined && dataset[iL - 1] !== undefined) {

                var left_dateBefore = dataset[iL - 1].month,
                    left_dateAfter = dataset[iL].month;

                var intfun = d3v3.interpolateNumber(dataset[iL - 1].count, dataset[iL].count);
                var yleft = intfun((xleft - left_dateBefore) / (left_dateAfter - left_dateBefore));
            } else {
                var yleft = 0;
            }

            // get the x value of the line at the right edge of view port:
            var iR = bisectDate(dataset, xright);

            if (dataset[iR] !== undefined && dataset[iR - 1] !== undefined) {

                var right_dateBefore = dataset[iR - 1].month,
                    right_dateAfter = dataset[iR].month;

                var intfun = d3v3.interpolateNumber(dataset[iR - 1].count, dataset[iR].count);
                var yright = intfun((xright - right_dateBefore) / (right_dateAfter - right_dateBefore));
            } else {
                var yright = 0;
            }

            // get the y values of all the actual data points that are in view
            var dataSubset = dataset.filter(function (d) {
                return d.month >= xleft && d.month <= xright;
            });
            var countSubset = [];
            dataSubset.map(function (d) {
                countSubset.push(d.count);
            });

            // add the edge values of the line to the array of counts in view, get the max y;
            countSubset.push(yleft);
            countSubset.push(yright);
            var ymax_new = d3v3.max(countSubset);

            if (ymax_new == 0) {
                ymax_new = dataYrange[1];
            }

            // reset and redraw the yaxis
            y.domain([0, ymax_new * 1.05]);
            focus.select(".y.axis").call(yAxis);

        };

        function scaleDate(d, i) {
// action for buttons that scale focus to certain time interval

            var b = brush.extent(),
                interval_ms,
                brush_end_new,
                brush_start_new;

            if (d == "year") {
                interval_ms = 31536000000
            } else if (d == "month") {
                interval_ms = 2592000000
            }
            ;

            if (d == "year" | d == "month") {

                if ((maxdate.getTime() - b[1].getTime()) < interval_ms) {
                    // if brush is too far to the right that increasing the right-hand brush boundary would make the chart go out of bounds....
                    brush_start_new = new Date(maxdate.getTime() - interval_ms); // ...then decrease the left-hand brush boundary...
                    brush_end_new = maxdate; //...and set the right-hand brush boundary to the maxiumum limit.
                } else {
                    // otherwise, increase the right-hand brush boundary.
                    brush_start_new = b[0];
                    brush_end_new = new Date(b[0].getTime() + interval_ms);
                }
                ;

            } else if (d == "data") {
                brush_start_new = dataXrange[0];
                brush_end_new = dataXrange[1]
            } else {
                brush_start_new = b[0];
                brush_end_new = b[1];
            }
            ;

            brush.extent([brush_start_new, brush_end_new]);

            // now draw the brush to match our extent
            brush(d3v3.select(".brush").transition());
            // now fire the brushstart, brushmove, and brushend events
            brush.event(d3v3.select(".brush").transition());
        }
    });
    }
    function updateChloropleth() {
        fetch('/chloropleth')
            .then(function (response) {
                return response.json()
            }).then(function (data) {
            fetch('/chloropleth-counties')
                .then(function (response) {
                    return response.json()
                }).then(function (data2) {
                document.getElementById("mysvg7").innerHTML = '';
                var width = 450
                var height = 250
                var padding = 20

                var projection = d3.geoAlbers()
                    .precision(0)
                    .scale(height * 2).translate([width / 2, height / 2])

                var path = d3.geoPath().projection(projection)

                var svg = d3.select('#mysvg7')
                    .attr('width', width)
                    .attr('height', height)
                var lowColor = '#f7f7f7'
                var highColor = '#2166ac'
                var dataArray = [];
                var dataArray2 = [];

                for (var d = 0; d < data.length; d++) {
                    // console.log(data[d])
                    dataArray.push(parseFloat(data[d].value))
                }
                for (var d = 0; d < data2.length; d++) {
                    // console.log(data[d])
                    dataArray2.push(parseFloat(data2[d].value))
                }
                var minVal = d3.min(dataArray)
                var maxVal = d3.max(dataArray)

                var ramp = d3.scaleLinear().domain([minVal, maxVal]).range([lowColor, highColor])


                d3.queue()
                    .defer(d3.json, 'static/us-states.json')
                    .defer(d3.json, 'static/us-counties.json')
                    .awaitAll(initialize)
                var statePaths, states, counties
                function initialize(error, results) {
                    if (error) {
                        throw error
                    }
                     states = topojson.feature(results[0], results[0].objects.states).features
                     counties = topojson.feature(results[1], results[1].objects.counties).features

                    states.forEach(function (f) {
                        f.properties = data.find(function (d) {
                            return d.state === f.properties.name
                        }) || f.properties
                    })
                    counties.forEach(function (f) {
                        console.log(f.id.substring(0,2))
                        var state1 = states.find(function (d) {
                            return d.id === f.id.substring(0,2)
                        })
                        console.log(state1)
                        f.properties = data2.find(function (d) {
                            return d.county === f.properties.name && d.state === state1.properties.state
                        }) || f.properties
                    })
                    console.log(data2)

                    statePaths = svg.selectAll('.state')
                        .data(states)
                        .enter().append('path')
                        .attr('class', 'state')
                        .attr('d', path)
                        .style("fill", function (d) {
                            return ramp(d.properties.value)
                        })
                        .on("mouseover", function (d) {
                            tooltip.transition()
                                .duration(250)
                                .style("opacity", 0);
                            tooltip.transition()
                                .duration(250)
                                .style("opacity", 1);
                            tooltip.html(
                                "<p><strong>" + d.properties.state + ": " + d.properties.value + "</strong></p>")
                                .style("left", (d3.event.pageX + 15) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                        })
                        .on("mouseout", function (d) {
                            tooltip.transition()
                                .duration(250)
                                .style("opacity", 0);
                        })
                        .on('click', function (d) {
                            time_update=false
                            stateZoom(d.id)
                        })
                        if(current_state!=-1) {
                            stateZoom(current_state)
                    }
                }
                    function usZoom() {
                    document.getElementById('map-heading').innerHTML='United States Of America'
                        // var t = d3.transition().duration(800)
                        //
                        // projection.scale(height * 2).translate([width / 2, height / 2])
                        //
                        // statePaths.transition(t)
                        //     .attr('d', path)
                        //     .style('fill', function (d) {
                        //         return ramp(d.properties.value)
                        //     })
                        //
                        // svg.selectAll('.county')
                        //     .data([])
                        //     .exit().transition(t)
                        //     .attr('d', path)
                        //     .style('opacity', 0)
                        //     .remove()
                        current_state=-1
                        fetch('/update/null', {
                            method: "POST",
                        }).then(function (response) {
                            updateRestOfChart()
                            updateTimeSeries()
                            updateChloropleth()
                        });
                    }

                    function stateZoom(id) {
                        current_state = id

                        var state = states.find(function (d) {
                            return d.id === id
                        })
                        var stateCounties = counties.filter(function (d) {
                            if (d.id > id && d.id < id + 999) {
                                return true;
                            }
                            return false;
                        })
                        let _data = {
                            state: state.properties.state
                        }
                        if(!time_update) {
                            fetch('/update/' + state.properties.state, {
                                method: "POST",
                                body: JSON.stringify(_data)
                            }).then(function (response) {
                                updateRestOfChart()
                                updateTimeSeries()
                            });
                        }
                        var dataArray2 = []
                        for (var d = 0; d < stateCounties.length; d++) {
                            dataArray2.push(parseFloat(stateCounties[d].properties.value))
                        }
                        var minVal2 = d3.min(dataArray2)
                        var maxVal2 = d3.max(dataArray2)

                        var ramp_counties = d3.scaleLinear().domain([minVal2, maxVal2]).range([lowColor, highColor])

                        var t = d3.transition().duration(800)

                        var countyPaths = svg.selectAll('.county')
                            .data(stateCounties, function (d) {
                                return d.id
                            })

                        var enterCountyPaths = countyPaths.enter().append('path')
                            .attr('class', 'county')
                            .attr('d', path)
                            .attr('subclass', function (d) {
                                return d.properties.county
                            })
                            .style('fill', function (d) {
                                return ramp_counties(d.properties.value || 0)
                            })
                            .style('opacity', 0)
                            .on("mouseover", function (d) {
                                tooltip.transition()
                                    .duration(250)
                                    .style("opacity", 0);
                                tooltip.transition()
                                    .duration(250)
                                    .style("opacity", 1);
                                tooltip.html(
                                    "<p><strong>" + d.properties.county + ": " + d.properties.value + "</strong></p>")
                                    .style("left", (d3.event.pageX + 15) + "px")
                                    .style("top", (d3.event.pageY - 28) + "px");
                            })
                            .on("mouseout", function (d) {
                                tooltip.transition()
                                    .duration(250)
                                    .style("opacity", 0);
                            })

                            .on('click', function () {
                                usZoom()
                            })

                        projection.fitExtent(
                            [[padding, padding], [width - padding, height - padding]],
                            state
                        )

                        statePaths.transition(t)
                            .attr('d', path)
                            .style('fill', '#444')

                        enterCountyPaths.transition(t)
                            .attr('d', path)
                            .style('opacity', 1)

                        countyPaths.exit().transition(t)
                            .attr('d', path)
                            .style('opacity', 0)
                            .remove()
                        document.getElementById("map-heading").innerHTML=state.properties.state
                        // add a legend
                var w = 130, h = 230;
                        document.getElementById("mysvg8").innerHTML = '';
                var key = d3.select("#mysvg8")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("class", "legend");

                var legend = key.append("defs")
                    .append("svg:linearGradient")
                    .attr("id", "gradient")
                    .attr("x1", "100%")
                    .attr("y1", "0%")
                    .attr("x2", "100%")
                    .attr("y2", "100%")
                    .attr("spreadMethod", "pad");

                legend.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", highColor)
                    .attr("stop-opacity", 1);

                legend.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", lowColor)
                    .attr("stop-opacity", 1);

                key.append("rect")
                    .attr("width", 30)
                    .attr("height", h)
                    .style("fill", "url(#gradient)")
                    .attr("transform", "translate(0,10)");

                var y = d3.scaleLinear()
                    .range([h, 0])
                    .domain([minVal2, maxVal2]);
                var yAxis = d3.axisRight(y);

                key.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(31,10)")
                    .call(yAxis)

                    }
                console.log('hi')
                document.getElementById("mysvg8").innerHTML=''
                // add a legend
                var w = 130, h = 230;

                var key = d3.select("#mysvg8")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("class", "legend");

                var legend = key.append("defs")
                    .append("svg:linearGradient")
                    .attr("id", "gradient")
                    .attr("x1", "100%")
                    .attr("y1", "0%")
                    .attr("x2", "100%")
                    .attr("y2", "100%")
                    .attr("spreadMethod", "pad");

                legend.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", highColor)
                    .attr("stop-opacity", 1);

                legend.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", lowColor)
                    .attr("stop-opacity", 1);

                key.append("rect")
                    .attr("width", 30)
                    .attr("height", h)
                    .style("fill", "url(#gradient)")
                    .attr("transform", "translate(0,10)");

                var y = d3.scaleLinear()
                    .range([h, 0])
                    .domain([minVal, maxVal]);

                var yAxis = d3.axisRight(y);

                key.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(31,10)")
                    .call(yAxis)
            });
        });
    }
    fetch('/update/null', {
                      method: "POST",
                    }).then(function(response){
                        updateRestOfChart()
                        updateTimeSeries()
                        updateChloropleth()
                    });

</script>
</body>

</script>


</body>
</html>